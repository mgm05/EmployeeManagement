<!DOCTYPE html>
<html>
<!--  header読み込み  -->
<div th:replace="~{common/header :: header_fragment}"></div>
<head>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" 
		rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<meta charset="UTF-8">
	<title>経費情報</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script>

		
		//追加ボタンを押下で入力フォーム追加
		function addTemplate(){
			//経費リストのインデックス番号を取得
			var templateIndex = $("#expenseTable tr").length-1;
			
			let cloneDom = $('#expenseTemplate').clone();
			var templateNameDoms = cloneDom.find('[name^="expenseRequestList"]');
			templateNameDoms.each(function(){
				var templateNameDom =  $(this);
				var templateName = templateNameDom.attr('name'); //name取得
				templateName = templateName.replace('0', templateIndex);
				templateNameDom.attr("name", templateName);
			});

			$(cloneDom).removeAttr('id');
			
			//入力フォームを追加
			$("#expenseTemplate").after(cloneDom);
			$(cloneDom).show();
			activateTemplate();
		}
		function templateNameChange(){
			//name変更をメソッド化する
		}
		
		//templateの活性化
		function activateTemplate(){
			$('input').prop('disabled', false);
			$('select').prop('disabled', false);
		}
	</script>
</head>
<body>
	<div class="container">
		<h1 style="margin-bottom: 20px; text-align: center;">経費情報</h1>
		<div style="text-align: right; margin: 10px;">
			<a class="btn btn-outline-secondary btn-sm" th:href="@{/dogDetail(dogId=${dogId})}">犬詳細へ戻る</a>
			<button class="btn btn-outline-secondary btn-sm" onclick="addTemplate()">追加</button>
		</div>
		<form action="/expense/regist" method="post" id="expenseForm" th:object="${expenseForm}">
			<input type="hidden" name="dogId" th:value="${dogId}">
			<span th:if="${#fields.hasErrors('expenseRequestList')}" th:errors="*{expenseRequestList}"/>
			<table class="table" id="expenseTable">
				<thead class="table-primary">
					<tr>
						<th></th>
						<th></th>
						<th>ステータス</th>
						<th>発生区分</th>
						<th>入出金区分</th>
						<th>種別</th>
						<th>内容</th>
						<th>見積金額</th>
						<th>確定金額</th>
						<th>発生日</th>
						<th>仕入日</th>
					</tr>
				</thead>
				<tbody>
					<tr id="expenseTemplate" style="display: none;">
						<td></td>
						<td></td>
						<td></td>
						<td><!-- 発生区分 -->
							<select disabled th:name="|expenseRequestList[0].occurrenceType|">
								<option></option>
								<option th:each="occurrenceType :${occurrenceTypeEnum}"
								th:value="${occurrenceType.code}" th:text="${occurrenceType.val}" selected="0">
								</option>
							</select>
							<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].occurrenceType')}" th:errors="*{expenseRequestList[__${stat.count}__].occurrenceType}"/>
						</td>
						<td><!-- 入出金区分 -->
							<select disabled th:name="|expenseRequestList[0].cashFlowType|">
								<option></option>
								<option th:each="cashFlowType :${cashFlowTypeEnum}"
								th:value="${cashFlowType.code}" th:text="${cashFlowType.val}">
								</option>
							</select>
						</td>
						<td><!-- 経費種別 -->
							<select disabled th:name="|expenseRequestList[0].expenseType|" >
								<option></option>
								<option th:each="expenseType :${expenseTypeEnum}"
									th:value="${expenseType.code}" th:text="${expenseType.val}"></option>
							</select>
						</td>
						<td><input disabled type="text" th:name="|expenseRequestList[0].info|"></td><!-- 内容 -->
						<td><input disabled type="text" th:name="|expenseRequestList[0].quotationYen|"></td><!-- 見積金額 -->
						<td><input disabled type="text" th:name="|expenseRequestList[0].closeYen|" ></td><!-- 確定金額 -->
						<td><input disabled type="date" th:name="|expenseRequestList[0].paymentDate|"></td><!-- 発生日 -->
						<td><input disabled type="date" th:name="|expenseRequestList[0].purchaseDate|"></td><!-- 仕入日 -->
					</tr>
					<!--	経費リスト-->
					<th:block th:each="expense,stat :${expenseList}">
						<tr id="expenseList">
							<input type="hidden" th:name="|expenseRequestList[${stat.count}].expenseId|" th:value="${expense.expenseId}">
							<input type="hidden" th:name="|expenseRequestList[${stat.count}].fixFlag|" th:value="${expense.fixFlag}">
							<td><button th:if="${expense.fixFlag} ==0">確定</button></td><!-- 確定 -->
							<td><button>取消</button></td><!-- 取消 -->
							<td><label th:text="${expense.status}"></label></td><!-- ステータス -->
							<td style="display: none;"><!-- 消すとエラー -->
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].info')}" th:errors="*{expenseRequestList[__${stat.count}__].info}"/>
							</td>
<!--ここから↑がエラー-->
							<td><!-- 発生区分 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="${expense.occurrenceType}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].occurrenceType|"  th:value="${expense.occurrenceType}">
									</th:block>
									<th:block th:case="0">
										<select th:name="|expenseRequestList[${stat.count}].occurrenceType|">
											<option th:if="!${expenseForm.expenseRequestList[__${stat.count}__].occurrenceType}" th:each="occurrenceType :${occurrenceTypeEnum}"
												th:value="${occurrenceType.code}" th:text="${occurrenceType.val}" th:selected="${expense.occurrenceType} == ${occurrenceType.code}">
											</option>
											<option th:if="${expenseForm.expenseRequestList[__${stat.count}__].occurrenceType}" th:each="occurrenceType :${occurrenceTypeEnum}"
												th:value="${occurrenceType.code}" th:text="${occurrenceType.val}" 
												th:selected="${expenseForm.expenseRequestList[__${stat.count}__].occurrenceType} == ${occurrenceType.code}">
											</option>
										</select>
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].occurrenceType')}" th:errors="*{expenseRequestList[__${stat.count}__].occurrenceType}"/>
							</td>
							<td><!-- 入出金区分 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="${expense.cashFlowType}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].cashFlowType|"  th:value="${expense.cashFlowType}">
									</th:block>
									<th:block th:case="0">
										<select th:name="|expenseRequestList[${stat.count}].cashFlowType|">
											<option th:if="!${expenseForm.expenseRequestList[__${stat.count}__].cashFlowType}"  th:each="cashFlowType :${cashFlowTypeEnum}"
												th:value="${cashFlowType.code}" th:text="${cashFlowType.val}" th:selected="${expense.cashFlowType} == ${cashFlowType.code}">
											</option>
											<option th:if="${expenseForm.expenseRequestList[__${stat.count}__].cashFlowType}"  th:each="cashFlowType :${cashFlowTypeEnum}"
												th:value="${cashFlowType.code}" th:text="${cashFlowType.val}" 
												th:selected="${expenseForm.expenseRequestList[__${stat.count}__].cashFlowType} == ${cashFlowType.code}">
											</option>
										</select>
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].cashFlowType')}" th:errors="*{expenseRequestList[__${stat.count}__].cashFlowType}"/>
							</td>
							<td><!-- 経費種別 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="${expense.expenseType}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].expenseType|"  th:value="${expense.expenseType}">
									</th:block>
									<th:block th:case="0">
										<select th:name="|expenseRequestList[${stat.count}].expenseType|">
											<option th:if="!${expenseForm.expenseRequestList[__${stat.count}__].cashFlowType}"  th:each="expenseType :${expenseTypeEnum}"
												th:value="${expenseType.code}" th:text="${expenseType.val}" th:selected="${expense.expenseType} == ${expenseType.code}">
											</option>
											<option th:if="${expenseForm.expenseRequestList[__${stat.count}__].expenseType}"  th:each="expenseType :${expenseTypeEnum}"
												th:value="${expenseType.code}" th:text="${expenseType.val}" 
												th:selected="${expenseForm.expenseRequestList[__${stat.count}__].expenseType} == ${expenseType.code}">
											</option>
										</select>
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].expenseType')}" th:errors="*{expenseRequestList[__${stat.count}__].expenseType}"/>
							</td>
							<td><!-- 内容 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="${expense.info}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].info|"  th:value="${expense.info}">
									</th:block>
									<th:block th:case="0">
										<input th:if="!${expenseForm.expenseRequestList[__${stat.count}__].info}" type="text" th:value="${expense.info}"  th:name="|expenseRequestList[${stat.count}].info|">
										<input th:if="${expenseForm.expenseRequestList[__${stat.count}__].info}" type="text" th:name="|expenseRequestList[${stat.count}].info|" 
											th:field="${expenseForm.expenseRequestList[__${stat.count}__].info}">
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].info')}" th:errors="*{expenseRequestList[__${stat.count}__].info}"/>
							</td>
							<td><!-- 見積金額 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="￥+${#numbers.formatInteger(expense.quotationYen, 3, 'COMMA')}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].quotationYen|" th:value="${expense.quotationYen}">
									</th:block>
									<th:block th:case="0">
										<input th:if="!${expenseForm.expenseRequestList[__${stat.count}__].quotationYen}" type="text" th:value="${expense.quotationYen}"  th:name="|expenseRequestList[${stat.count}].quotationYen|">
										<input th:if="${expenseForm.expenseRequestList[__${stat.count}__].quotationYen}" type="text" th:name="|expenseRequestList[${stat.count}].quotationYen|" 
											th:field="${expenseForm.expenseRequestList[__${stat.count}__].quotationYen}">
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].quotationYen')}" th:errors="*{expenseRequestList[__${stat.count}__].quotationYen}"/>
							</td>
							<td><!-- 確定金額 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:if="${expense.fixFlag} ==1" th:text="'￥'+${#numbers.formatInteger(expense.closeYen, 3, 'COMMA')}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].closeYen|" th:value="${expense.closeYen}">
									</th:block>
									<th:block th:case="0">
										<input th:if="!${expenseForm.expenseRequestList[__${stat.count}__].closeYen}" type="text" th:value="${expense.closeYen}"  th:name="|expenseRequestList[${stat.count}].closeYen|">
										<input th:if="${expenseForm.expenseRequestList[__${stat.count}__].closeYen}" type="text" th:name="|expenseRequestList[${stat.count}].closeYen|" 
											th:field="${expenseForm.expenseRequestList[__${stat.count}__].closeYen}">
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].closeYen')}" th:errors="*{expenseRequestList[__${stat.count}__].closeYen}"/>
							</td>
							<td><!-- 発生日 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:text="${expense.paymentDate}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].paymentDate|" th:value="${expense.paymentDate}">
									</th:block>
									<th:block th:case="0">
										<input th:if="!${expenseForm.expenseRequestList[__${stat.count}__].paymentDate}" type="date" th:value="${expense.paymentDate}" th:name="|expenseRequestList[${stat.count}].paymentDate|">
										<input th:if="${expenseForm.expenseRequestList[__${stat.count}__].paymentDate}" type="date" th:name="|expenseRequestList[${stat.count}].paymentDate|" 
											th:field="${expenseForm.expenseRequestList[__${stat.count}__].paymentDate}">
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].paymentDate')}" th:errors="*{expenseRequestList[__${stat.count}__].paymentDate}"/>
							</td>
							<td><!-- 仕入日 -->
								<th:block th:switch="${expense.fixFlag}">
									<th:block th:case="1">
										<label th:if="${expense.fixFlag} ==1" th:text="${expense.purchaseDate}"></label>
										<input type="hidden" th:name="|expenseRequestList[${stat.count}].purchaseDate|" th:value="${expense.purchaseDate}">
									</th:block>
									<th:block th:case="0">
										<input th:if="!${expenseForm.expenseRequestList[__${stat.count}__].purchaseDate}" type="date" th:value="${expense.purchaseDate}" th:name="|expenseRequestList[${stat.count}].purchaseDate|">
										<input th:if="${expenseForm.expenseRequestList[__${stat.count}__].purchaseDate}" type="date" th:name="|expenseRequestList[${stat.count}].purchaseDate|" 
											th:field="${expenseForm.expenseRequestList[__${stat.count}__].purchaseDate}">
									</th:block>
								</th:block>
								<span th:if="${#fields.hasErrors('expenseRequestList[__${stat.count}__].purchaseDateValid')}" th:errors="*{expenseRequestList[__${stat.count}__].purchaseDateValid}"/>
							</td>
						</tr>
					</th:block>
				</form>
			</tbody>
		</table>
		<div style="text-align: right; margin: 10px;">
			<button class="btn btn-outline-secondary btn-sm" form="expenseForm">登録</button>
		</div>
	</div>
</body>
</html>